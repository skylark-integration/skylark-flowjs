/**
 * skylark-flowjs - A version of flowjs that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-flowjs/
 * @license MIT
 */
define(["skylark-langx/langx","./flowjs","./utils","./FlowFile"],function(e,t,i,n){"use strict";var s=i.each,r=i.async,o=i.extend,a=i.arrayRemove,l=window.navigator.msPointerEnabled;function u(e){if(this.support=!("undefined"==typeof File||"undefined"==typeof Blob||"undefined"==typeof FileList||!Blob.prototype.slice&&!Blob.prototype.webkitSlice&&!Blob.prototype.mozSlice),this.support){this.supportDirectory=/Chrome/.test(window.navigator.userAgent)||/Firefox/.test(window.navigator.userAgent)||/Edge/.test(window.navigator.userAgent),this.files=[],this.defaults={chunkSize:1048576,forceChunkSize:!1,simultaneousUploads:3,singleFile:!1,fileParameterName:"file",progressCallbacksInterval:500,speedSmoothingFactor:.1,query:{},headers:{},withCredentials:!1,preprocess:null,method:"multipart",testMethod:"GET",uploadMethod:"POST",prioritizeFirstAndLastChunk:!1,allowDuplicateUploads:!1,target:"/",testChunks:!0,generateUniqueIdentifier:null,maxChunkRetries:0,chunkRetryInterval:null,permanentErrors:[404,413,415,500,501],successStatuses:[200,201,202],onDropStopPropagation:!1,initFileFn:null,readFileFn:f},this.opts={},this.events={};var t=this;this.onDrop=function(e){t.opts.onDropStopPropagation&&e.stopPropagation(),e.preventDefault();var i=e.dataTransfer;i.items&&i.items[0]&&i.items[0].webkitGetAsEntry?t.webkitReadDataTransfer(e):t.addFiles(i.files,e)},this.preventEvent=function(e){e.preventDefault()},this.opts=o({},this.defaults,e||{})}}function f(e,t,i,n,s){var r="slice";e.file.slice?r="slice":e.file.mozSlice?r="mozSlice":e.file.webkitSlice&&(r="webkitSlice"),s.readFinished(e.file[r](t,i,n))}return u.prototype={on:function(e,t){e=e.toLowerCase(),this.events.hasOwnProperty(e)||(this.events[e]=[]),this.events[e].push(t)},off:function(e,t){void 0!==e?(e=e.toLowerCase(),void 0!==t?this.events.hasOwnProperty(e)&&a(this.events[e],t):delete this.events[e]):this.events={}},fire:function(e,t){t=Array.prototype.slice.call(arguments),e=e.toLowerCase();var i=!1;return this.events.hasOwnProperty(e)&&s(this.events[e],function(e){i=!1===e.apply(this,t.slice(1))||i},this),"catchall"!=e&&(t.unshift("catchAll"),i=!1===this.fire.apply(this,t)||i),!i},webkitReadDataTransfer:function(e){var t=this,i=e.dataTransfer.items.length,n=[];function r(e,t){e.relativePath=t.substring(1),n.push(e),a()}function o(e){throw e}function a(){0==--i&&t.addFiles(n,e)}s(e.dataTransfer.items,function(e){var t=e.webkitGetAsEntry();t?t.isFile?r(e.getAsFile(),t.fullPath):function e(t){t.readEntries(function(n){n.length?(i+=n.length,s(n,function(t){if(t.isFile){var i=t.fullPath;t.file(function(e){r(e,i)},o)}else t.isDirectory&&e(t.createReader())}),e(t)):a()},o)}(t.createReader()):a()})},generateUniqueIdentifier:function(e){var t=this.opts.generateUniqueIdentifier;if("function"==typeof t)return t(e);var i=e.relativePath||e.webkitRelativePath||e.fileName||e.name;return e.size+"-"+i.replace(/[^0-9a-zA-Z_-]/gim,"")},uploadNextChunk:function(e){var t=!1;if(this.opts.prioritizeFirstAndLastChunk&&(s(this.files,function(e){return!e.paused&&e.chunks.length&&"pending"===e.chunks[0].status()?(e.chunks[0].send(),t=!0,!1):!e.paused&&e.chunks.length>1&&"pending"===e.chunks[e.chunks.length-1].status()?(e.chunks[e.chunks.length-1].send(),t=!0,!1):void 0}),t))return t;if(s(this.files,function(e){if(e.paused||s(e.chunks,function(e){if("pending"===e.status())return e.send(),t=!0,!1}),t)return!1}),t)return!0;var i=!1;return s(this.files,function(e){if(!e.isComplete())return i=!0,!1}),i||e||r(function(){this.fire("complete")},this),!1},assignBrowse:function(e,t,i,n){e instanceof Element&&(e=[e]),s(e,function(e){var r;"INPUT"===e.tagName&&"file"===e.type?r=e:((r=document.createElement("input")).setAttribute("type","file"),o(r.style,{visibility:"hidden",position:"absolute",width:"1px",height:"1px"}),e.appendChild(r),e.addEventListener("click",function(){r.click()},!1)),this.opts.singleFile||i||r.setAttribute("multiple","multiple"),t&&r.setAttribute("webkitdirectory","webkitdirectory"),s(n,function(e,t){r.setAttribute(t,e)});var a=this;r.addEventListener("change",function(e){e.target.value&&(a.addFiles(e.target.files,e),e.target.value="")},!1)},this)},assignDrop:function(e){void 0===e.length&&(e=[e]),s(e,function(e){e.addEventListener("dragover",this.preventEvent,!1),e.addEventListener("dragenter",this.preventEvent,!1),e.addEventListener("drop",this.onDrop,!1)},this)},unAssignDrop:function(e){void 0===e.length&&(e=[e]),s(e,function(e){e.removeEventListener("dragover",this.preventEvent),e.removeEventListener("dragenter",this.preventEvent),e.removeEventListener("drop",this.onDrop)},this)},isUploading:function(){var e=!1;return s(this.files,function(t){if(t.isUploading())return e=!0,!1}),e},_shouldUploadNext:function(){var e=0,t=!0,i=this.opts.simultaneousUploads;return s(this.files,function(n){s(n.chunks,function(n){if("uploading"===n.status()&&++e>=i)return t=!1,!1})}),t&&e},upload:function(){var e=this._shouldUploadNext();if(!1!==e){this.fire("uploadStart");for(var t=!1,i=1;i<=this.opts.simultaneousUploads-e;i++)t=this.uploadNextChunk(!0)||t;t||r(function(){this.fire("complete")},this)}},resume:function(){s(this.files,function(e){e.isComplete()||e.resume()})},pause:function(){s(this.files,function(e){e.pause()})},cancel:function(){for(var e=this.files.length-1;e>=0;e--)this.files[e].cancel()},progress:function(){var e=0,t=0;return s(this.files,function(i){e+=i.progress()*i.size,t+=i.size}),t>0?e/t:0},addFile:function(e,t){this.addFiles([e],t)},addFiles:function(e,t){var i=[];s(e,function(e){if((!l||l&&e.size>0)&&(e.size%4096!=0||"."!==e.name&&"."!==e.fileName)){var s=this.generateUniqueIdentifier(e);if(this.opts.allowDuplicateUploads||!this.getFromUniqueIdentifier(s)){var r=new n(this,e,s);this.fire("fileAdded",r,t)&&i.push(r)}}},this),this.fire("filesAdded",i,t)&&(s(i,function(e){this.opts.singleFile&&this.files.length>0&&this.removeFile(this.files[0]),this.files.push(e)},this),this.fire("filesSubmitted",i,t))},removeFile:function(e){for(var t=this.files.length-1;t>=0;t--)this.files[t]===e&&(this.files.splice(t,1),e.abort(),this.fire("fileRemoved",e))},getFromUniqueIdentifier:function(e){var t=!1;return s(this.files,function(i){i.uniqueIdentifier===e&&(t=i)}),t},getSize:function(){var e=0;return s(this.files,function(t){e+=t.size}),e},sizeUploaded:function(){var e=0;return s(this.files,function(t){e+=t.sizeUploaded()}),e},timeRemaining:function(){var e=0,t=0;return s(this.files,function(i){i.paused||i.error||(e+=i.size-i.sizeUploaded(),t+=i.averageSpeed)}),e&&!t?Number.POSITIVE_INFINITY:e||t?Math.floor(e/t):0}},t.Flow=u});
//# sourceMappingURL=sourcemaps/Flow.js.map
